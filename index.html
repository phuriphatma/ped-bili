<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Neonatal Age & Bilirubin (Demo)</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#0ea5e9" />
  
</head>
<body>
  <header>
    <h1>AAP 2022 Hyperbilirubinemia Management Guidelines</h1>
    <p class="disclaimer">For demonstration only, inspired by https://peditools.org/bili2022/</p>
    <div style="margin-top: 10px;">
      <button onclick="forceRefreshCache()" style="background: #0ea5e9; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
        ðŸ”„ Refresh Cache
      </button>
    </div>
  </header>

  <main>
    <section class="card">
      <h2>Inputs</h2>
      <form id="controls" onsubmit="return false;">
        <div class="grid">
          <label>
            <span>Gestation at birth</span>
            <select id="ga">
              <option value="35">35 weeks</option>
              <option value="36">36 weeks</option>
              <option value="37">37 weeks</option>
              <option value="38">38 weeks</option>
              <option value="39">39 weeks</option>
              <option value="40">40+ weeks</option>
            </select>
          </label>

          <label>
            <span>Age (hours)</span>
            <input id="ageHours" type="text" placeholder="e.g., 24 or 12,24,48" />
            <small>1â€“336 hours; comma-separated list allowed</small>
          </label>

          <label>
            <span>Bilirubin (mg/dL)</span>
            <input id="bili" type="text" placeholder="optional; e.g., 10 or 8,9,11" />
            <small>Optional; comma-separated list allowed</small>
          </label>

          <fieldset class="inline">
            <legend>Neurotoxicity risks</legend>
            <label><input type="radio" name="risk" value="no_risk" /> No risk factors</label>
            <label><input type="radio" name="risk" value="any_risk" checked /> ANY risk factors</label>
            <label><input type="radio" name="risk" value="both" /> Show both</label>
          </fieldset>

          
        </div>

        <div class="actions">
          <button id="resetBtn" type="reset">Reset form</button>
        </div>
      </form>
    </section>

    <section class="card">
      <h2>Results</h2>
      <div id="summary" class="summary"></div>
    </section>

    <section class="card">
      <h2>Optional age calculator</h2>
      <div class="grid">
        <label>
          <span>Date of birth</span>
          <input id="dob" type="datetime-local" />
        </label>
        <label>
          <span>Date of measurement</span>
          <input id="dom" type="datetime-local" />
        </label>
        <div class="actions">
          <button id="calcAgeBtn" type="button">Calculate age</button>
        </div>
      </div>
    </section>

    

    <section class="card">
      <h2>Verify AAP table (optional)</h2>
      <p class="small">Paste 15 rows Ã— 24 values (360 numbers) for the selected GA. Choose Exchange (Table 4) or Phototherapy (Table 2). Non-numeric text will be ignored.</p>
      <div class="grid">
        <label>
          <span>Dataset</span>
          <select id="datasetKind">
            <option value="exchange" selected>Exchange (AAP Table 4)</option>
            <option value="phototherapy">Phototherapy (AAP Table 2)</option>
          </select>
        </label>
        <label>
          <span>Paste table values</span>
          <textarea id="verifyInput" rows="6" style="width:100%;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace"></textarea>
        </label>
      </div>
      <div class="actions">
        <button id="verifyBtn" type="button">Verify against JS dataset</button>
        <button id="exportBtn" type="button">Export JS dataset JSON</button>
      </div>
      <div id="verifyOutput" class="summary"></div>

      <hr/>
      <h3>Convert pasted table to JS dataset rows</h3>
      <p class="small">Converts the day/hour table into array-of-arrays rows, ready to paste inside the dataset file.</p>
      <div class="actions">
        <button id="convertBtn" type="button">Convert to JS rows</button>
        <button id="copyConvertBtn" type="button">Copy output</button>
      </div>
      <label>
        <span class="small">JS rows output</span>
        <textarea id="convertOutput" rows="8" readonly style="width:100%;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace"></textarea>
      </label>
    </section>

    <section class="card">
      <h2>Usage notes</h2>
      <ul>
        <li>Leave bilirubin blank to view thresholds only.</li>
        <li>Enter comma-separated ages and bilirubin to plot trends.</li>
        <li>Recommendation is based on the last age/value pair provided.</li>
      </ul>
      <details>
        <summary>Neurotoxicity risk factors (examples)</summary>
        <ul>
          <li>Albumin &lt; 3 g/dL</li>
          <li>Isoimmune hemolytic disease</li>
          <li>G6PD deficiency or other hemolytic conditions</li>
          <li>Sepsis or clinical instability in the prior 24 hours</li>
          <li>Prematurity is accounted for by gestational-age selection</li>
        </ul>
      </details>
      <p class="disclaimer small">References: AAP 2022 Hyperbilirubinemia guideline. This demo does not reproduce the original curves; values shown are illustrative.</p>
    </section>
  </main>

  <script src="thresholds_demo.js"></script>
  <script src="thresholds_aap_anyrisk_exchange.js"></script>
  <script src="thresholds_aap_anyrisk_phototherapy.js"></script>
  <script src="app.js"></script>
  
  <script>
    // Service Worker registration and cache management
    let serviceWorkerRegistration = null;
    
    // Register Service Worker for offline functionality
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then((registration) => {
            serviceWorkerRegistration = registration;
            console.log('ServiceWorker registration successful with scope: ', registration.scope);
            
            // Listen for service worker updates
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  // New service worker is available
                  showUpdateNotification();
                }
              });
            });
          })
          .catch((error) => {
            console.log('ServiceWorker registration failed: ', error);
          });
          
        // Listen for messages from service worker
        navigator.serviceWorker.addEventListener('message', (event) => {
          if (event.data && event.data.type === 'CACHE_REFRESHED') {
            console.log('Cache refreshed:', event.data.message);
            showRefreshNotification('Cache updated successfully!');
          }
        });
      });
    } else {
      console.log('ServiceWorker is not supported in this browser.');
    }
    
    // Function to force cache refresh
    function forceRefreshCache() {
      if (navigator.serviceWorker.controller) {
        navigator.serviceWorker.controller.postMessage({
          type: 'FORCE_CACHE_REFRESH'
        });
        showRefreshNotification('Refreshing cache...');
      }
    }
    
    // Show update notification
    function showUpdateNotification() {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #0ea5e9;
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 1000;
        max-width: 300px;
      `;
      notification.innerHTML = `
        <div>New version available!</div>
        <button onclick="refreshApp()" style="margin-top: 10px; background: white; color: #0ea5e9; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
          Update Now
        </button>
        <button onclick="this.parentElement.remove()" style="margin-left: 10px; background: transparent; color: white; border: 1px solid white; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
          Later
        </button>
      `;
      document.body.appendChild(notification);
    }
    
    // Show refresh notification
    function showRefreshNotification(message) {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #22c55e;
        color: white;
        padding: 10px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 1000;
      `;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }
    
    // Refresh the application
    function refreshApp() {
      if (serviceWorkerRegistration && serviceWorkerRegistration.waiting) {
        serviceWorkerRegistration.waiting.postMessage({ type: 'SKIP_WAITING' });
        window.location.reload();
      } else {
        forceRefreshCache();
        setTimeout(() => window.location.reload(), 1000);
      }
    }
  </script>
</body>
</html>
